{% load static %}
{% load attendance_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - {{ group.name }}</title>
    <link rel="stylesheet" href="{% static 'css/mark_attendance.css' %}">
</head>
<body>
    <form method="post" id="attendanceForm">
        {% csrf_token %}
        
        <div class="container">
            <!-- HEADER -->
            <div class="header">
                <h2>{{ group.subject.name }} - {{ group.name }}</h2>
                <div class="header-info">
                    {{ group.grade.name }} | Academic Year 2024-2025
                </div>
            </div>

            <!-- CONTROLS -->
            <div class="controls">
                <div class="control-group">
                    <label for="monthSelect">Month:</label>
                    <input type="month" 
                           id="monthSelect" 
                           name="month"
                           class="month-selector"
                           value="{{ selected_month }}"
                           onchange="this.form.submit()">
                </div>

                <button type="button" class="btn-add-student" onclick="openAddStudentModal()">
                    + Add Student
                </button>
            </div>

            <!-- ATTENDANCE SHEET -->
            <div class="attendance-sheet">
                <table class="sheet-table">
                    <thead>
                        <tr>
                            <th class="student-col">Student</th>
                            {% for date in dates %}
                            <th>
                                <div class="date-header">
                                    <span class="date-day">{{ date }}</span>
                                    <span class="date-weekday">{{ date|date:"D" }}</span>
                                </div>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        {% for student in students %}
                        <tr>
                            <td class="student-cell">
                                <div class="student-name">{{ student.user.get_full_name }}</div>
                                <div class="student-id">ID: {{ student.student_id }}</div>
                            </td>
                            {% for date in dates %}
                            <td class="status-cell">
                                {% get_attendance records student.id date as status %}
                                {% get_status_icon records student.id date as icon %}

                                <input type="hidden"
                                    name="attendance_{{ student.id }}_{{ date|date:'Y-m-d' }}"
                                    id="status_{{ student.id }}_{{ date|date:'Y-m-d' }}"
                                    value="{{ status }}">

                                <button type="button"
                                        class="status-btn {% if status %}{{ status|lower }}{% endif %}"
                                        onclick="toggleStatus({{ student.id }}, '{{ date|date:'Y-m-d' }}', this)">
                                    {{ icon }}
                                </button>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- FOOTER -->
            <div class="footer">
                <div class="legend">
                    <div class="legend-item">
                        <span class="legend-icon" style="background: #d4edda; border: 2px solid #28a745;"></span>
                        <span>Present (âœ“)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon" style="background: #f8d7da; border: 2px solid #dc3545;"></span>
                        <span>Absent (âœ—)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon" style="background: #fff3cd; border: 2px solid #ffc107;"></span>
                        <span>Late (L)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon" style="background: #e2e3e5; border: 2px solid #6c757d;"></span>
                        <span>Holiday (H)</span>
                    </div>
                </div>

                <button type="submit" class="btn-submit">
                    ðŸ’¾ Save Attendance
                </button>
            </div>
        </div>
    </form>

    <!-- ADD STUDENT MODAL -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                Add Student to {{ group.name }}
            </div>

            <form method="post" action="{% url 'add_student' group.id %}">
                {% csrf_token %}

                <div class="form-section">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text"
                            name="student_name"
                            placeholder="Enter full name"
                            required>
                    </div>

                    <div class="form-group">
                        <label>Student ID</label>
                        <input type="text"
                            name="student_id"
                            placeholder="e.g. 101"
                            required>
                    </div>

                    <div class="form-group">
                        <label>Email (optional)</label>
                        <input type="email"
                            name="student_email"
                            placeholder="student@example.com">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn-cancel"
                            onclick="closeAddStudentModal()">
                        Cancel
                    </button>

                    <button type="submit" class="btn-submit">
                         Add Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {

        const statusCycle = ['PRESENT', 'ABSENT', 'LATE', 'HOLIDAY'];
        const statusIcons = {
            PRESENT: 'âœ“',
            ABSENT: 'âœ—',
            LATE: 'L',
            HOLIDAY: 'H'
        };

        window.toggleStatus = function (studentId, date, button) {
            const input = document.getElementById(`status_${studentId}_${date}`);
            const index = statusCycle.indexOf(input.value);
            const next = statusCycle[(index + 1) % statusCycle.length];

            input.value = next;
            button.textContent = statusIcons[next];
            button.className = 'status-btn ' + next.toLowerCase();
        };

        window.openAddStudentModal = function () {
            document.getElementById('addStudentModal').classList.add('active');
        };

        window.closeAddStudentModal = function () {
            document.getElementById('addStudentModal').classList.remove('active');
        };

    });
    </script>
</body>
</html>